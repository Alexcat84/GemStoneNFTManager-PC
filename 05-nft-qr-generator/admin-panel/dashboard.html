<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GemStone NFT QR Generator - Dashboard v2.3</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-logout {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            padding: 0;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            flex: 1;
            text-align: center;
            border-radius: 8px 8px 0 0;
        }

        .tab-button:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
            width: 100%;
        }

        .tab-content.active {
            display: block;
        }

        /* Code Generator Styles */
        .codes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .code-item {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .code-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
        }

        .code-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .code-title-section {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .code-title {
            font-weight: bold;
            font-size: 1.3rem;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            font-family: 'Courier New', monospace;
            letter-spacing: 1px;
        }

        .code-date-section {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .code-date {
            color: rgba(255,255,255,0.8);
            font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .code-details {
            color: rgba(255,255,255,0.95);
            font-size: 0.95rem;
            line-height: 1.6;
            background: rgba(255,255,255,0.1);
            padding: 1rem;
            border-radius: 8px;
            backdrop-filter: blur(10px);
            margin-bottom: 1rem;
        }

        .code-details strong {
            color: #ffffff;
            font-weight: 600;
        }

        .copy-btn-inline {
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.3);
        }

        .copy-btn-inline:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(16, 185, 129, 0.4);
        }

        .delete-btn-inline {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn-inline:hover {
            background: #dc2626;
            transform: translateY(-1px) scale(1.1);
            box-shadow: 0 3px 8px rgba(239, 68, 68, 0.4);
        }

        /* Clean design - simple action buttons */

        /* Search area styling */
        .form-group label {
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-group input[type="text"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: #ffffff;
        }

        .form-group input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .form-group input[type="text"]::placeholder {
            color: #a0aec0;
        }

        /* Empty state styling */
        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #718096;
            background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
            border-radius: 12px;
            border: 2px dashed #cbd5e0;
        }

        .empty-state::before {
            content: '💎';
            font-size: 3rem;
            display: block;
            margin-bottom: 1rem;
        }

        .empty-state h3 {
            color: #4a5568;
            margin-bottom: 0.5rem;
            font-size: 1.2rem;
        }

        .empty-state p {
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .main-content {
            display: block;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
        }

        .card-body {
            padding: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            user-select: text;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .nft-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .nft-item {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nft-item:last-child {
            border-bottom: none;
        }

        .nft-info {
            flex: 1;
        }

        .nft-code {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.25rem;
        }

        .nft-details {
            font-size: 0.9rem;
            color: #666;
        }

        .nft-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 6px;
        }

        .qr-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .qr-modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            position: relative;
        }

        .qr-modal-close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .qr-modal-close:hover {
            color: #000;
        }

        .qr-image {
            max-width: 100%;
            height: auto;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .qr-download-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
        }

        .qr-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">💎 GemStone NFT QR Generator</div>
        <div class="user-info">
            <span>Administrator</span>
            <button class="btn-logout" onclick="openChangePasswordModal()">Change Password</button>
            <button class="btn-logout" onclick="logout()">Log Out</button>
        </div>
    </div>

    <div class="container">
        <!-- Messages -->
        <div class="message success" id="successMessage"></div>
        <div class="message error" id="errorMessage"></div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchTab('qr-generator')">QR Generator</button>
                <button class="tab-button" onclick="switchTab('code-generator')">Code Generator</button>
            </div>

            <!-- QR Generator Tab -->
            <div id="qr-generator-tab" class="tab-content active">
                <!-- Generate QR Form -->
            <div class="card">
                <div class="card-header">
                    Generate QR Code
                </div>
                <div class="card-body">
                    <form id="qrForm">
                        <div class="form-group">
                            <label for="url">URL:</label>
                            <input type="text" id="url" name="url" required 
                                   placeholder="https://opensea.io/assets/ethereum/... or https://gemspots.com/qr/..."
                                   autocomplete="off"
                                   spellcheck="false">
                        </div>
                        
                        <div class="form-group">
                            <label for="status">Status:</label>
                            <select id="status" name="status">
                                <option value="ready">Ready (Direct Link)</option>
                                <option value="pending">Pending (NFT in Process)</option>
                                <option value="custom">Custom URL</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="nftUrlGroup" style="display: none;">
                            <label for="nft_url">NFT URL (when ready):</label>
                            <input type="text" id="nft_url" name="nft_url" 
                                   placeholder="https://opensea.io/assets/ethereum/..."
                                   autocomplete="off"
                                   spellcheck="false">
                        </div>
                        
                        <div class="form-group" id="estimatedDateGroup" style="display: none;">
                            <label for="estimated_ready_date">Estimated Ready Date:</label>
                            <input type="datetime-local" id="estimated_ready_date" name="estimated_ready_date">
                        </div>
                        
                        <div class="form-group">
                            <label for="notes">Notes (optional):</label>
                            <textarea id="notes" name="notes" rows="2" 
                                      placeholder="Additional notes about this QR code..."></textarea>
                        </div>
                        
                        <button type="submit" class="btn" id="generateBtn">
                            Generate QR
                        </button>
                    </form>
                </div>
            </div>

            <!-- QR Codes List -->
            <div class="card">
                <div class="card-header">
                    Generated QR Codes
                </div>
                <div class="card-body">
                    <!-- Search Filter -->
                    <div class="form-group" style="margin-bottom: 1rem;">
                        <label for="searchFilter">Search QR Codes:</label>
                        <input type="text" id="searchFilter" placeholder="Search by URL or QR ID..." 
                               style="width: 100%; padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px;">
                    </div>
                    
                    <!-- Date/Time Filters -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label for="dateFrom">From Date:</label>
                            <input type="datetime-local" id="dateFrom" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px;">
                        </div>
                        <div class="form-group">
                            <label for="dateTo">To Date:</label>
                            <input type="datetime-local" id="dateTo" 
                                   style="width: 100%; padding: 8px 12px; border: 2px solid #e1e5e9; border-radius: 6px;">
                        </div>
                    </div>
                    
                    <!-- Quick Date Filters -->
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-small btn-secondary" onclick="setDateFilter('today')">Today</button>
                        <button class="btn btn-small btn-secondary" onclick="setDateFilter('yesterday')">Yesterday</button>
                        <button class="btn btn-small btn-secondary" onclick="setDateFilter('thisWeek')">This Week</button>
                        <button class="btn btn-small btn-secondary" onclick="setDateFilter('thisMonth')">This Month</button>
                        <button class="btn btn-small btn-secondary" onclick="clearDateFilter()">Clear Dates</button>
                    </div>
                    
                    <div class="nft-list" id="qrList">
                        <p style="text-align: center; color: #666; padding: 2rem;">No QR codes generated yet.</p>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="pagination" style="display: none; text-align: center; margin-top: 1rem; padding: 1rem; border-top: 1px solid #e1e5e9;">
                        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem;">
                            <button id="prevPage" class="btn btn-small btn-secondary" onclick="changePage(-1)">← Previous</button>
                            <span id="pageInfo" style="color: #666; font-size: 0.9rem;"></span>
                            <button id="nextPage" class="btn btn-small btn-secondary" onclick="changePage(1)">Next →</button>
                        </div>
                        <div style="margin-top: 0.5rem;">
                            <label for="itemsPerPage" style="font-size: 0.8rem; color: #666;">Items per page:</label>
                            <select id="itemsPerPage" onchange="changeItemsPerPage()" style="margin-left: 0.5rem; padding: 2px 6px; border: 1px solid #ccc; border-radius: 4px;">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
                        </div>
                        
            <!-- Code Generator Tab -->
            <div id="code-generator-tab" class="tab-content">
                <!-- Generate Code Form -->
                <div class="card">
                    <div class="card-header">
                        Generate NFT Code
                    </div>
                    <div class="card-body">
                        <form id="codeForm">
                        <div class="form-group">
                                <label for="gemstoneInput">Gemstones:</label>
                                <input type="text" id="gemstoneInput" placeholder="Enter gemstone names (e.g., Amethyst, Quartz, Ruby)" class="form-input">
                                <small class="form-help">Separate multiple gemstones with commas</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="locationSelect">Location:</label>
                                <select id="locationSelect" required>
                                    <option value="">Select Location...</option>
                            </select>
                        </div>
                        
                            <div class="form-row">
                        <div class="form-group">
                                    <label for="monthSelect">Month:</label>
                                    <select id="monthSelect" required>
                                        <option value="">Select Month...</option>
                                        <option value="1">January</option>
                                        <option value="2">February</option>
                                        <option value="3">March</option>
                                        <option value="4">April</option>
                                        <option value="5">May</option>
                                        <option value="6">June</option>
                                        <option value="7">July</option>
                                        <option value="8">August</option>
                                        <option value="9">September</option>
                                        <option value="10">October</option>
                                        <option value="11">November</option>
                                        <option value="12">December</option>
                                    </select>
                        </div>
                        
                        <div class="form-group">
                                    <label for="yearInput">Year:</label>
                                    <input type="number" id="yearInput" min="2020" max="2030" value="2025" required>
                                </div>
                        </div>
                        
                            <div class="form-group">
                                <label for="notesInput">Notes (optional):</label>
                                <textarea id="notesInput" placeholder="Additional notes about this code..." rows="3"></textarea>
                            </div>
                            
                            <button type="submit" class="btn">Generate Code</button>
                    </form>
                </div>
            </div>

                <!-- Generated Codes List -->
            <div class="card">
                <div class="card-header">
                        Generated Codes
                </div>
                <div class="card-body">
                        <!-- Search Filter -->
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label for="codeSearchFilter">Search Codes:</label>
                            <input type="text" id="codeSearchFilter" placeholder="Search by code, gemstone, or notes..." onkeyup="filterCodes()">
                        </div>
                        
                        <!-- Codes List -->
                        <div id="codesList" class="codes-list">
                            <!-- Generated codes will appear here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Modal -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-modal-content">
            <span class="qr-modal-close" onclick="closeQRModal()">&times;</span>
            <h3>💎 Generated QR Code</h3>
            <div id="qrImageContainer">
                <img id="qrImage" class="qr-image" src="" alt="QR Code">
            </div>
            <p id="qrUrl" style="color: #666; margin: 1rem 0; word-break: break-all;"></p>
            <p id="qrTimestamp" style="color: #999; font-size: 0.9rem; margin: 0.5rem 0;"></p>
            <button class="qr-download-btn" onclick="downloadQR()">
                📥 Download QR in HD
            </button>
        </div>
    </div>

    <!-- Edit QR Modal -->
    <div id="editModal" class="qr-modal">
        <div class="qr-modal-content" style="max-width: 600px;">
            <span class="qr-modal-close" onclick="closeEditModal()">&times;</span>
            <h3>✏️ Edit QR Code</h3>
            <form id="editForm">
                <div class="form-group">
                    <label for="editUrl">URL:</label>
                    <input type="text" id="editUrl" name="url" required 
                           placeholder="https://opensea.io/assets/ethereum/... or https://gemspots.com/qr/..."
                           autocomplete="off"
                           spellcheck="false">
                </div>
                
                <div class="form-group">
                    <label for="editStatus">Status:</label>
                    <select id="editStatus" name="status">
                        <option value="ready">Ready (Direct Link)</option>
                        <option value="pending">Pending (NFT in Process)</option>
                        <option value="custom">Custom URL</option>
                    </select>
                </div>
                
                <div class="form-group" id="editNftUrlGroup" style="display: none;">
                    <label for="editNftUrl">NFT URL (when ready):</label>
                    <input type="text" id="editNftUrl" name="nft_url" 
                           placeholder="https://opensea.io/assets/ethereum/..."
                           autocomplete="off"
                           spellcheck="false">
                </div>
                
                <div class="form-group" id="editEstimatedDateGroup" style="display: none;">
                    <label for="editEstimatedDate">Estimated Ready Date:</label>
                    <input type="datetime-local" id="editEstimatedDate" name="estimated_ready_date">
                </div>
                
                <div class="form-group">
                    <label for="editNotes">Notes (optional):</label>
                    <textarea id="editNotes" name="notes" rows="2" 
                              placeholder="Additional notes about this QR code..."></textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn" id="updateBtn">
                        Update QR
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="qr-modal">
        <div class="qr-modal-content" style="max-width: 500px;">
            <span class="qr-modal-close" onclick="closeChangePasswordModal()">&times;</span>
            <h3>🔐 Change Password</h3>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label for="currentPassword">Current Password:</label>
                    <input type="password" id="currentPassword" name="oldPassword" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">New Password:</label>
                    <input type="password" id="newPassword" name="newPassword" required minlength="8">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Confirm New Password:</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="8">
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">
                        Cancel
                    </button>
                    <button type="submit" class="btn" id="changePasswordBtn">
                        Change Password
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let qrs = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let filteredQRs = null;

        // Check authentication
        if (!localStorage.getItem('adminToken')) {
            window.location.href = '/';
        }

        // Load initial data
        document.addEventListener('DOMContentLoaded', function() {
            loadQRs();
            setupSearchFilter();
            setupDateFilters();
            setupFormHandlers();
            // Load locations for code generator
            loadLocations();
        });

        async function loadQRs() {
            try {
                const response = await fetch('/api/qrs');
                const data = await response.json();
                if (data.success) {
                    qrs = data.qrs;
                    // Sort by creation date (newest first)
                    qrs.sort((a, b) => {
                        const dateA = new Date(a.created_at);
                        const dateB = new Date(b.created_at);
                        return dateB - dateA; // Newest first
                    });
                    renderQRs();
                }
            } catch (error) {
                console.error('Error loading QRs:', error);
            }
        }

        function renderQRs(qrsToRender = null) {
            const container = document.getElementById('qrList');
            const pagination = document.getElementById('pagination');
            
            // Use filtered QRs if provided, otherwise use all QRs
            let qrsToShow = qrsToRender || qrs;
            filteredQRs = qrsToRender;
            
            // Sort by creation date (newest first)
            qrsToShow = qrsToShow.sort((a, b) => {
                const dateA = new Date(a.created_at);
                const dateB = new Date(b.created_at);
                return dateB - dateA; // Newest first
            });
            
            if (qrsToShow.length === 0) {
                if (qrsToRender && qrs.length > 0) {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No QR codes found matching your search.</p>';
                } else {
                    container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No QR codes generated yet.</p>';
                }
                pagination.style.display = 'none';
                return;
            }

            // Calculate pagination
            const totalPages = Math.ceil(qrsToShow.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageQRs = qrsToShow.slice(startIndex, endIndex);

            // Render QRs for current page
            container.innerHTML = pageQRs.map(qr => {
                const statusBadge = getStatusBadge(qr.status);
                const statusInfo = getStatusInfo(qr);
                
                return `
                <div class="nft-item">
                    <div class="nft-info">
                            <div class="nft-code">QR #${qr.id} ${statusBadge}</div>
                        <div class="nft-details">
                                <strong>QR URL:</strong> http://192.168.18.19:3000/qr/${qr.id}<br>
                                <strong>Redirects to:</strong> ${qr.url}
                            </div>
                            ${statusInfo}
                            <div class="nft-timestamp" style="color: #999; font-size: 0.8rem; margin-top: 0.25rem;">
                                ${qr.timestamp || new Date(qr.created_at).toLocaleString()}
                        </div>
                    </div>
                    <div class="nft-actions">
                            <button class="btn btn-small" onclick="viewQR('${qr.id}')">
                                View QR
                        </button>
                            <button class="btn btn-small btn-secondary" onclick="editQR('${qr.id}')">
                                Edit
                        </button>
                    </div>
                </div>
                `;
            }).join('');

            // Update pagination
            updatePagination(qrsToShow.length, totalPages);
        }

        function updatePagination(totalItems, totalPages) {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');

            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }

            pagination.style.display = 'block';
            
            // Update page info
            const startItem = (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalItems);
            pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${startItem}-${endItem} of ${totalItems})`;

            // Update button states
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }

        function changePage(direction) {
            const qrsToShow = filteredQRs || qrs;
            const totalPages = Math.ceil(qrsToShow.length / itemsPerPage);
            
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderQRs(filteredQRs);
            }
        }

        function changeItemsPerPage() {
            itemsPerPage = parseInt(document.getElementById('itemsPerPage').value);
            currentPage = 1; // Reset to first page
            renderQRs(filteredQRs);
        }

        function setupSearchFilter() {
            const searchInput = document.getElementById('searchFilter');
            searchInput.addEventListener('input', applyFilters);
        }

        function setupDateFilters() {
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            
            dateFrom.addEventListener('change', applyFilters);
            dateTo.addEventListener('change', applyFilters);
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchFilter').value.toLowerCase().trim();
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            // Reset to first page when applying filters
            currentPage = 1;
            
            let filteredQRs = qrs;
            
            // Text search filter
            if (searchTerm !== '') {
                filteredQRs = filteredQRs.filter(qr => 
                    qr.url.toLowerCase().includes(searchTerm) ||
                    qr.id.toLowerCase().includes(searchTerm) ||
                    (qr.timestamp && qr.timestamp.toLowerCase().includes(searchTerm))
                );
            }
            
            // Date range filter
            if (dateFrom || dateTo) {
                filteredQRs = filteredQRs.filter(qr => {
                    const qrDate = new Date(qr.created_at);
                    const fromDate = dateFrom ? new Date(dateFrom) : null;
                    const toDate = dateTo ? new Date(dateTo) : null;
                    
                    if (fromDate && qrDate < fromDate) return false;
                    if (toDate && qrDate > toDate) return false;
                    
                    return true;
                });
            }
            
            renderQRs(filteredQRs);
        }

        function setDateFilter(period) {
            const now = new Date();
            const dateFrom = document.getElementById('dateFrom');
            const dateTo = document.getElementById('dateTo');
            
            switch(period) {
                case 'today':
                    const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const todayEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                    dateFrom.value = todayStart.toISOString().slice(0, 16);
                    dateTo.value = todayEnd.toISOString().slice(0, 16);
                    break;
                    
                case 'yesterday':
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStart = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate());
                    const yesterdayEnd = new Date(yesterday.getFullYear(), yesterday.getMonth(), yesterday.getDate(), 23, 59, 59);
                    dateFrom.value = yesterdayStart.toISOString().slice(0, 16);
                    dateTo.value = yesterdayEnd.toISOString().slice(0, 16);
                    break;
                    
                case 'thisWeek':
                    const weekStart = new Date(now);
                    weekStart.setDate(now.getDate() - now.getDay());
                    weekStart.setHours(0, 0, 0, 0);
                    dateFrom.value = weekStart.toISOString().slice(0, 16);
                    dateTo.value = now.toISOString().slice(0, 16);
                    break;
                    
                case 'thisMonth':
                    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                    dateFrom.value = monthStart.toISOString().slice(0, 16);
                    dateTo.value = now.toISOString().slice(0, 16);
                    break;
            }
            
            applyFilters();
        }

        function clearDateFilter() {
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            applyFilters();
        }

        function getStatusBadge(status) {
            const badges = {
                'ready': '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">READY</span>',
                'pending': '<span style="background: #ffc107; color: black; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">PENDING</span>',
                'custom': '<span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; margin-left: 0.5rem;">CUSTOM</span>'
            };
            return badges[status] || '';
        }

        function getStatusInfo(qr) {
            if (qr.status === 'pending' && qr.estimated_ready_date) {
                const date = new Date(qr.estimated_ready_date);
                const now = new Date();
                const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
                
                if (diffDays > 0) {
                    return `<div style="color: #ffc107; font-size: 0.8rem; margin-top: 0.25rem;">⏳ Ready in ${diffDays} days</div>`;
                } else if (diffDays === 0) {
                    return `<div style="color: #28a745; font-size: 0.8rem; margin-top: 0.25rem;">✅ Ready today!</div>`;
                } else {
                    return `<div style="color: #dc3545; font-size: 0.8rem; margin-top: 0.25rem;">⚠️ Overdue by ${Math.abs(diffDays)} days</div>`;
                }
            } else if (qr.status === 'custom' && qr.nft_url) {
                return `<div style="color: #17a2b8; font-size: 0.8rem; margin-top: 0.25rem;">🔗 Custom redirect active</div>`;
            }
            return '';
        }

        function setupFormHandlers() {
            // Status change handlers for main form
            document.getElementById('status').addEventListener('change', function() {
                toggleFormFields(this.value, 'nftUrlGroup', 'estimatedDateGroup');
            });
            
            // Status change handlers for edit form
            document.getElementById('editStatus').addEventListener('change', function() {
                toggleFormFields(this.value, 'editNftUrlGroup', 'editEstimatedDateGroup');
            });
        }

        function toggleFormFields(status, nftUrlGroupId, estimatedDateGroupId) {
            const nftUrlGroup = document.getElementById(nftUrlGroupId);
            const estimatedDateGroup = document.getElementById(estimatedDateGroupId);
            
            if (status === 'pending') {
                nftUrlGroup.style.display = 'block';
                estimatedDateGroup.style.display = 'block';
            } else if (status === 'custom') {
                nftUrlGroup.style.display = 'block';
                estimatedDateGroup.style.display = 'none';
            } else {
                nftUrlGroup.style.display = 'none';
                estimatedDateGroup.style.display = 'none';
            }
        }

        document.getElementById('qrForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                url: document.getElementById('url').value,
                status: document.getElementById('status').value,
                nft_url: document.getElementById('nft_url').value || null,
                estimated_ready_date: document.getElementById('estimated_ready_date').value || null,
                notes: document.getElementById('notes').value || null
            };

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating...';

            try {
                const response = await fetch('/api/qr/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('QR code generated successfully!', 'success');
                    e.target.reset();
                    loadQRs();
                } else {
                    showMessage(result.message || 'Error generating QR code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Connection error. Please try again.', 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate QR';
            }
        });

        let currentQRId = null;

        function viewQR(qrId) {
            currentQRId = qrId;
            const qr = qrs.find(q => q.id === qrId);
            if (qr) {
                document.getElementById('qrImage').src = `/qr-codes/qr-${qrId}.png`;
                document.getElementById('qrUrl').innerHTML = `
                    <strong>QR URL:</strong> http://192.168.18.19:3000/qr/${qrId}<br>
                    <strong>Redirects to:</strong> ${qr.url}
                `;
                document.getElementById('qrTimestamp').textContent = `Generated: ${qr.timestamp || new Date(qr.created_at).toLocaleString()}`;
                document.getElementById('qrModal').style.display = 'block';
            }
        }

        function closeQRModal() {
            document.getElementById('qrModal').style.display = 'none';
            currentQRId = null;
        }

        function downloadQR() {
            if (currentQRId) {
                const link = document.createElement('a');
                link.href = `/qr-codes/qr-${currentQRId}.png`;
                link.download = `qr-code-${currentQRId}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const qrModal = document.getElementById('qrModal');
            const editModal = document.getElementById('editModal');
            const changePasswordModal = document.getElementById('changePasswordModal');
            
            if (event.target === qrModal) {
                closeQRModal();
            } else if (event.target === editModal) {
                closeEditModal();
            } else if (event.target === changePasswordModal) {
                closeChangePasswordModal();
            }
        }

        function showMessage(message, type) {
            const messageEl = document.getElementById(type === 'success' ? 'successMessage' : 'errorMessage');
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        let currentEditQRId = null;

        async function editQR(qrId) {
            currentEditQRId = qrId;
            
            try {
                const response = await fetch(`/api/qr/details/${qrId}`);
                const data = await response.json();
                
                if (data.success) {
                    const qr = data.qr;
                    
                    // Populate edit form
                    document.getElementById('editUrl').value = qr.url || '';
                    document.getElementById('editStatus').value = qr.status || 'ready';
                    document.getElementById('editNftUrl').value = qr.nft_url || '';
                    document.getElementById('editNotes').value = qr.notes || '';
                    
                    // Set estimated date if exists
                    if (qr.estimated_ready_date) {
                        const date = new Date(qr.estimated_ready_date);
                        document.getElementById('editEstimatedDate').value = date.toISOString().slice(0, 16);
                    }
                    
                    // Toggle form fields based on status
                    toggleFormFields(qr.status || 'ready', 'editNftUrlGroup', 'editEstimatedDateGroup');
                    
                    // Show edit modal
                    document.getElementById('editModal').style.display = 'block';
                } else {
                    showMessage('Error loading QR details', 'error');
                }
            } catch (error) {
                console.error('Error loading QR details:', error);
                showMessage('Connection error. Please try again.', 'error');
            }
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditQRId = null;
        }

        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                url: document.getElementById('editUrl').value,
                status: document.getElementById('editStatus').value,
                nft_url: document.getElementById('editNftUrl').value || null,
                estimated_ready_date: document.getElementById('editEstimatedDate').value || null,
                notes: document.getElementById('editNotes').value || null
            };

            const updateBtn = document.getElementById('updateBtn');
            updateBtn.disabled = true;
            updateBtn.textContent = 'Updating...';

            try {
                const response = await fetch(`/api/qr/update/${currentEditQRId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage('QR code updated successfully!', 'success');
                    closeEditModal();
                    loadQRs();
                } else {
                    showMessage(result.message || 'Error updating QR code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showMessage('Connection error. Please try again.', 'error');
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Update QR';
            }
        });

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('sessionId');
            window.location.href = '/';
        }

        // Tab Functions
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for the active tab
            if (tabName === 'code-generator') {
                loadLocations();
                loadGeneratedCodes();
            }
        }

        // Change Password Functions
        function openChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'block';
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').style.display = 'none';
            document.getElementById('changePasswordForm').reset();
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const oldPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (newPassword !== confirmPassword) {
                showMessage('New passwords do not match', 'error');
                return;
            }
            
            if (newPassword.length < 8) {
                showMessage('New password must be at least 8 characters long', 'error');
                return;
            }
            
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            changePasswordBtn.disabled = true;
            changePasswordBtn.textContent = 'Changing...';
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/change-password', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ oldPassword, newPassword })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Password changed successfully!', 'success');
                    closeChangePasswordModal();
                } else {
                    showMessage(result.message || 'Error changing password', 'error');
                }
            } catch (error) {
                console.error('Error changing password:', error);
                showMessage('Error changing password. Please try again.', 'error');
            } finally {
                changePasswordBtn.disabled = false;
                changePasswordBtn.textContent = 'Change Password';
            }
        });

        // Code Generator Functions
        let generatedCodes = [];
        let locations = [];

        // Load locations for code generator - DEBUG VERSION
        async function loadLocations() {
            console.log('🔄 Loading locations...');
            try {
                const token = localStorage.getItem('adminToken');
                console.log('🔑 Token found:', token ? 'YES' : 'NO');
                
                const response = await fetch('/api/locations', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('📡 Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('📊 Data received:', data);
                locations = data;
                
                const locationSelect = document.getElementById('locationSelect');
                if (!locationSelect) {
                    console.error('❌ Location select element not found!');
                    return;
                }
                
                locationSelect.innerHTML = '<option value="">Select Location...</option>';
                
                data.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id;
                    option.textContent = `${location.region}, ${location.country}`;
                    locationSelect.appendChild(option);
                });
                
                console.log('✅ Locations loaded successfully:', data.length);
                showMessage(`✅ ${data.length} locations loaded successfully!`, 'success');
            } catch (error) {
                console.error('❌ Error loading locations:', error);
                showMessage(`❌ Error loading locations: ${error.message}`, 'error');
            }
        }

        // Load generated codes
        async function loadGeneratedCodes() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/codes', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                generatedCodes = Array.isArray(data) ? data : [];
                renderCodes();
            } catch (error) {
                console.error('Error loading codes:', error);
                generatedCodes = []; // Ensure it's always an array
                renderCodes();
            }
        }

        // Render codes list
        function renderCodes() {
            const codesList = document.getElementById('codesList');
            if (!Array.isArray(generatedCodes) || generatedCodes.length === 0) {
                codesList.innerHTML = `
                    <div class="empty-state">
                        <h3>No codes generated yet</h3>
                        <p>Start by filling out the form above to generate your first NFT code!</p>
                    </div>
                `;
                return;
            }

            codesList.innerHTML = generatedCodes.map(code => `
                <div class="code-item">
                    <div class="code-header">
                        <div class="code-title-section">
                            <div class="code-title">${code.full_code}</div>
                            <button class="copy-btn-inline" onclick="copyCode('${code.full_code}')">
                                📋 Copy
                            </button>
                        </div>
                        <div class="code-date-section">
                            <div class="code-date">${new Date(code.generation_date).toLocaleDateString()}</div>
                            <button class="delete-btn-inline" onclick="deleteCode(${code.id}, '${code.full_code}')">
                                🗑️
                            </button>
                        </div>
                    </div>
                    <div class="code-details">
                        <strong>Gemstones:</strong> ${JSON.parse(code.gemstone_names).join(', ')}<br>
                        <strong>Location:</strong> ${getLocationName(code.location_id)}<br>
                        <strong>Month/Year:</strong> ${code.month}/${code.year}<br>
                        <strong>Piece Number:</strong> ${code.piece_number}<br>
                        ${code.notes ? `<strong>Notes:</strong> ${code.notes}` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Get location name by ID
        function getLocationName(locationId) {
            const location = locations.find(loc => loc.id === locationId);
            return location ? `${location.region}, ${location.country}` : 'Unknown';
        }

        // Copy code to clipboard
        function copyCode(code) {
            navigator.clipboard.writeText(code).then(() => {
                showMessage('Code copied to clipboard!', 'success');
            }).catch(() => {
                showMessage('Failed to copy code', 'error');
            });
        }

        // Delete code with confirmation
        async function deleteCode(codeId, codeName) {
            // Show confirmation dialog
            const confirmed = confirm(`Are you sure you want to delete the code "${codeName}"?\n\nThis action cannot be undone!`);
            
            if (!confirmed) {
                return;
            }
            
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/codes/${codeId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`Code "${codeName}" deleted successfully!`, 'success');
                    // Reload the codes list
                    await loadGeneratedCodes();
                } else {
                    showMessage(result.message || 'Error deleting code', 'error');
                }
            } catch (error) {
                console.error('Error deleting code:', error);
                showMessage('Error deleting code. Please try again.', 'error');
            }
        }

        // This function was removed - QR generation should be done in QR Generator tab only

        // Filter codes
        function filterCodes() {
            const filter = document.getElementById('codeSearchFilter').value.toLowerCase();
            const filteredCodes = generatedCodes.filter(code => 
                code.full_code.toLowerCase().includes(filter) ||
                code.gemstone_names.toLowerCase().includes(filter) ||
                (code.notes && code.notes.toLowerCase().includes(filter))
            );
            
            // Temporarily replace the codes list with filtered results
            const originalCodes = generatedCodes;
            generatedCodes = filteredCodes;
            renderCodes();
            generatedCodes = originalCodes;
        }

        // Handle code form submission
        document.getElementById('codeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const gemstoneInput = document.getElementById('gemstoneInput').value;
            const locationId = document.getElementById('locationSelect').value;
            const month = document.getElementById('monthSelect').value;
            const year = document.getElementById('yearInput').value;
            const notes = document.getElementById('notesInput').value;
            
            if (!gemstoneInput || !locationId || !month || !year) {
                showMessage('Please fill in all required fields', 'error');
                return;
            }
            
            const gemstoneNames = gemstoneInput.split(',').map(name => name.trim()).filter(name => name);
            
            try {
                const response = await fetch('/api/codes/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({
                        gemstoneNames,
                        locationId: parseInt(locationId),
                        month: parseInt(month),
                        year: parseInt(year),
                        notes
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(`Code generated successfully: ${result.fullCode}`, 'success');
                    document.getElementById('codeForm').reset();
                    document.getElementById('yearInput').value = '2025'; // Reset year
                    loadGeneratedCodes();
                } else {
                    showMessage(result.message || 'Error generating code', 'error');
                }
            } catch (error) {
                console.error('Error generating code:', error);
                showMessage('Error generating code. Please try again.', 'error');
            }
        });
    </script>
</body>
</html>